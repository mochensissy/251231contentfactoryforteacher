// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 用户表
model User {
  id            String   @id @default(cuid())
  phone         String   @unique
  nickname      String?
  avatar        String?
  balance       Int      @default(0)  // 剩余次数
  totalPaid     Float    @default(0)  // 累计充值金额
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  analysisTasks AnalysisTask[]
  orders        Order[]

  @@map("users")
}

// 订单表
model Order {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  amount        Float    // 充值金额
  quantity      Int      // 购买次数
  status        String   @default("pending") // pending/paid/failed/refunded
  paymentMethod String?  @map("payment_method") // wechat/alipay
  transactionId String?  @map("transaction_id")
  paidAt        DateTime? @map("paid_at")
  createdAt     DateTime @default(now()) @map("created_at")

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("orders")
}

// 分析任务表
model AnalysisTask {
  id              Int       @id @default(autoincrement())
  keyword         String
  userId          String?   @map("user_id") // 关联用户ID

  // 新增：来源类型和公众号信息
  sourceType      String    @default("keyword") @map("source_type") // "keyword" | "account_history"
  mpName          String?   @map("mp_name")     // 公众号名称（仅历史分析）
  mpGhid          String?   @map("mp_ghid")     // 公众号原始ID（仅历史分析）

  status          String    @default("pending") // pending/processing/completed
  totalArticles   Int?      @map("total_articles")
  analyzedAt      DateTime? @map("analyzed_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  report          InsightReport?
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("analysis_tasks")
}

// 洞察报告表（包含完整文章数据）
model InsightReport {
  id                      Int       @id @default(autoincrement())
  taskId                  Int       @unique @map("task_id") // 一个任务对应一个报告
  topLikesArticles        String    @map("top_likes_articles") // JSON格式
  topEngagementArticles   String    @map("top_engagement_articles") // JSON格式
  wordCloud               String    @map("word_cloud") // JSON格式
  insights                String    // JSON格式
  rawArticles             String    @map("raw_articles") // JSON格式 - 保存完整的原始文章数据，可离线查看

  // AI增强数据
  articleSummaries        String?   @map("article_summaries") // JSON格式 - AI提取的文章摘要
  enhancedInsights        String?   @map("enhanced_insights") // JSON格式 - AI生成的深度洞察

  // 统计数据
  readDistribution        String?   @map("read_distribution") // JSON格式
  timeDistribution        String?   @map("time_distribution") // JSON格式

  createdAt               DateTime  @default(now()) @map("created_at")

  task                    AnalysisTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("insight_reports")
}

// 文章表（用于AI生成的文章）
model Article {
  id              Int       @id @default(autoincrement())
  title           String
  content         String    // Markdown格式
  summary         String?
  source          String    @default("ai_generated") // ai_generated/imported
  status          String    @default("draft") // draft/pending_review/published

  // 创作参数
  wordCount       String?   @map("word_count") // 字数范围
  writeStyle      String?   @map("write_style") // 写作风格
  imageCount      Int?      @map("image_count") // 配图数量
  images          String?   // JSON格式 - 配图URL数组

  // 关联信息
  taskId          Int?      @map("task_id") // 关联的分析任务ID
  insightTitle    String?   @map("insight_title") // 来源洞察的标题

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  publishRecords  PublishRecord[]

  @@map("articles")
}

// 发布记录表
model PublishRecord {
  id              Int       @id @default(autoincrement())
  articleId       Int       @map("article_id")
  platform        String    // xiaohongshu/wechat
  platformId      String?   @map("platform_id")
  status          String    @default("pending") // pending/success/failed
  errorMessage    String?   @map("error_message")
  publishedAt     DateTime? @map("published_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  article         Article   @relation(fields: [articleId], references: [id])

  @@map("publish_records")
}

// 系统配置表
model Setting {
  id              Int       @id @default(autoincrement())
  key             String    @unique
  value           String?
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("settings")
}
