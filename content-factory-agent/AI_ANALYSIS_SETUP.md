# AI 深度选题分析 - 配置指南

## 🎉 功能更新

选题分析功能已升级为 **AI 深度分析模式**！

### ✨ 新增特性

1. **两阶段 AI 分析**
   - 第一阶段：AI 提取 TOP 文章的结构化摘要
   - 第二阶段：基于摘要生成 5 条深度洞察

2. **增强的洞察信息**
   - 选题分类（趋势/痛点/方法论/案例等）
   - 目标受众画像
   - 内容切入角度
   - 建议大纲（3-5个要点）
   - 参考文章
   - 置信度评分
   - 推荐理由

3. **优化的用户体验**
   - 可展开/收起详细信息
   - 更详细的进度提示
   - 向后兼容历史数据

---

## 🔧 配置步骤

### 1. 配置环境变量

编辑 `.env` 文件，添加 OpenRouter API 配置：

```bash
# AI API Configuration (OpenRouter)
OPENROUTER_API_URL="https://openrouter.ai/api/v1/chat/completions"
OPENROUTER_API_KEY="your-api-key-here"  # 替换为你的 API Key
OPENROUTER_MODEL="google/gemini-2.0-flash-thinking-exp:free"
```

#### 获取 OpenRouter API Key

1. 访问 [OpenRouter](https://openrouter.ai/)
2. 注册/登录账号
3. 进入 [Keys](https://openrouter.ai/keys) 页面
4. 创建新的 API Key
5. 复制 Key 并粘贴到 `.env` 文件中

#### 模型选择建议

**免费模型（推荐用于测试）：**
```bash
OPENROUTER_MODEL="google/gemini-2.0-flash-thinking-exp:free"
```

**付费模型（更高质量）：**
```bash
# GPT-4
OPENROUTER_MODEL="openai/gpt-4-turbo"

# Claude 3.5 Sonnet
OPENROUTER_MODEL="anthropic/claude-3.5-sonnet"

# Gemini Pro
OPENROUTER_MODEL="google/gemini-pro"
```

查看所有可用模型：https://openrouter.ai/models

---

### 2. 启动开发服务器

```bash
npm run dev
```

访问：http://localhost:3000/topic-analysis

---

## 📊 分析流程

```
输入关键词
    ↓
获取 20 篇公众号文章 (20%)
    ↓
提取点赞 TOP5 + 互动率 TOP5 (50%)
    ↓
AI 提取文章摘要（5-8 篇）(55% → 70%)
    - 提取关键观点、关键词、亮点
    - 分析内容类型、受众、风格
    ↓
AI 生成深度洞察（5 条）(70% → 85%)
    - 结合摘要数据
    - 结合词云数据
    - 生成可操作的选题建议
    ↓
保存到数据库 (85% → 100%)
    ↓
展示分析报告
```

---

## 💡 使用示例

### 输入关键词
```
AI
```

### 分析过程（约 20-30 秒）
1. ✅ 正在获取公众号文章... (5秒)
2. ✅ 已获取 20 篇文章，正在分析...
3. ✅ AI 正在提取文章摘要... (10-15秒)
4. ✅ AI 正在生成深度洞察... (8-12秒)
5. ✅ 正在保存分析结果...
6. ✅ 分析完成！

### 输出示例

**洞察 1：AI 工具在内容创作中的实战应用**
- **分类**：方法论
- **置信度**：92%
- **描述**：基于 TOP 文章分析，AI 辅助写作工具获得了高度关注...
- **目标受众**：内容创作者、自媒体运营者
- **切入角度**：从实用工具推荐切入，结合真实案例
- **建议大纲**：
  1. AI 写作工具的选择标准
  2. 3个热门工具的实战对比
  3. 提升效率的5个技巧
  4. 避坑指南和注意事项
- **推荐理由**：
  ✓ 3 篇 TOP 文章均提到 AI 工具，热度高
  ✓ 实用性强，读者互动率达 8.5%
  ✓ 话题时效性好，契合当下趋势

**点击"展开"查看完整信息**

---

## 🎨 UI 功能说明

### 洞察卡片

1. **基础信息**（始终显示）
   - 序号 + 分类标签
   - 洞察标题
   - 置信度徽章
   - 核心描述

2. **详细信息**（点击"展开"显示）
   - 🎯 目标受众
   - 📍 内容切入角度
   - 📝 建议大纲
   - ✓ 推荐理由
   - 📄 参考文章

3. **操作按钮**
   - **展开/收起**：查看详细信息
   - **一键创作**：跳转到内容创作页面（待实现）

---

## 💰 成本估算

### Token 使用（基于 Gemini 2.0 Flash）

**单次分析（关键词：AI，20 篇文章）：**

| 步骤 | Token 数 | 说明 |
|-----|---------|------|
| 摘要提取 | ~15,000 | 6篇文章 × 2,500 tokens/篇 |
| 洞察生成 | ~5,000 | 摘要总结 + 生成洞察 |
| **总计** | **~20,000** | 约 0.02 元（使用免费模型为 0） |

**免费模型（推荐）：**
- Gemini 2.0 Flash Thinking (Free)
- 无限制使用
- 适合开发和测试

**付费模型成本参考：**
- GPT-4 Turbo: ~0.15 元/次
- Claude 3.5 Sonnet: ~0.20 元/次

---

## 🔍 验证步骤

### 1. 检查配置
```bash
# 确保 .env 文件包含正确的 API Key
cat content-factory-agent/.env | grep OPENROUTER_API_KEY
```

### 2. 测试 API 连接
访问 http://localhost:3000/topic-analysis，输入任意关键词（如 "AI"）

### 3. 观察控制台日志
```bash
🚀 开始分析 20 篇文章...
📈 步骤 1/4: 计算基础指标...
✅ 提取了 15 个高频词

🤖 步骤 2/4: AI 提取文章摘要...
📊 选取了 6 篇 TOP 文章进行深度分析
✅ 成功提取 6 篇文章摘要

💡 步骤 3/4: AI 生成深度洞察...
✅ 成功生成 5 条深度洞察

📦 步骤 4/4: 构建分析结果...
✅ 分析完成！
```

---

## ⚠️ 常见问题

### 1. API Key 无效
**错误信息**：`AI API 调用失败: 401`

**解决方案**：
- 检查 `.env` 文件中的 `OPENROUTER_API_KEY`
- 确保 API Key 有效且未过期
- 重启开发服务器（Ctrl+C 后重新运行 `npm run dev`）

### 2. 模型不存在
**错误信息**：`AI API 调用失败: 404`

**解决方案**：
- 检查 `OPENROUTER_MODEL` 配置
- 使用 https://openrouter.ai/models 查看可用模型
- 推荐使用：`google/gemini-2.0-flash-thinking-exp:free`

### 3. 生成洞察失败
**错误信息**：`生成选题洞察失败，请检查 AI API 配置或重试`

**可能原因**：
- AI 返回格式不正确（模型温度过高）
- 文章内容过短或质量低
- 网络连接问题

**解决方案**：
- 重新运行分析
- 更换关键词
- 检查网络连接

### 4. 分析速度慢
**原因**：需要多次 AI 调用（6-8 次摘要 + 1 次洞察）

**优化建议**：
- 使用更快的模型（Gemini Flash）
- 减少分析的文章数量（修改 TOP 文章数量）
- 使用更强的服务器配置

---

## 📈 后续优化方向

1. **缓存机制**
   - 缓存相同关键词的分析结果
   - 减少重复的 AI 调用

2. **流式输出**
   - 实时显示摘要提取进度
   - 逐条展示生成的洞察

3. **批量分析**
   - 支持多个关键词批量分析
   - 生成对比报告

4. **导出功能**
   - 导出为 PDF 或 Markdown
   - 分享到团队

5. **成本控制**
   - 每日/每月调用次数限制
   - 预估成本提示

---

## 📞 技术支持

如遇问题，请检查：
1. `.env` 配置是否正确
2. API Key 是否有效
3. 网络连接是否正常
4. 控制台错误日志

开发服务器日志位置：终端输出

---

**祝使用愉快！🎉**
