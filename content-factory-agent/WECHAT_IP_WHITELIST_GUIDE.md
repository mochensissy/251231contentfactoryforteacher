# 微信公众号IP白名单配置指南

## 问题说明

发布到微信公众号时出现错误：
```
获取access_token失败: invalid ip 185.180.13.100, not in whitelist
```

这是因为服务器IP地址没有添加到微信公众号的IP白名单中。

## 解决方案

### 方法1：使用设置页面获取IP（推荐）

1. **访问设置页面**
   - 打开 http://localhost:3000/settings
   - 切换到"平台配置"标签页

2. **获取IP地址**
   - 在"微信公众号配置"卡片中找到"IP白名单配置"黄色提示框
   - 点击"📋 获取本机IP地址"按钮
   - IP会自动显示并复制到剪贴板

3. **添加到微信后台**
   - 登录微信公众号后台：https://mp.weixin.qq.com
   - 进入"开发 → 基本配置"
   - 找到"IP白名单"，点击"修改"
   - 粘贴IP地址，点击"确定"

### 方法2：手动查询IP

如果自动获取失败，可以手动查询：

1. 访问以下任一网站查看服务器公网IP：
   - https://api.ipify.org
   - https://ifconfig.me
   - https://ip.sb

2. 将获取的IP添加到微信公众号后台

## 常见问题

### Q: 为什么需要配置IP白名单？
A: 微信公众号为了安全性，要求所有调用API的服务器IP都必须预先添加到白名单中。

### Q: IP地址会变化吗？
A: 
- 如果是固定IP服务器，IP不会变化
- 如果是动态IP网络，IP可能会变化，需要重新添加
- 建议使用固定IP的服务器部署

### Q: 可以添加多个IP吗？
A: 可以。微信公众号后台支持添加多个IP地址，用换行分隔即可。

### Q: 添加IP后需要等待吗？
A: 一般添加后立即生效，无需等待。如果还是失败，请等待1-2分钟后重试。

### Q: IPv6地址需要添加吗？
A: 如果服务器同时支持IPv4和IPv6，建议都添加。格式：
```
185.180.13.100
::ffff:185.180.13.100
```

## 已实现的功能

### 设置页面新增功能
✅ IP白名单配置区域（黄色提示框）
✅ 一键获取本机IP按钮
✅ 自动复制IP到剪贴板
✅ 显示IP地址
✅ 详细配置步骤说明
✅ 尝试多个IP查询服务（提高成功率）

### 技术实现
- 调用公共IP查询API：ipify.org, ip.sb, ifconfig.me
- 支持IPv4和IPv6地址识别
- 自动重试机制
- 友好的用户提示

## 微信公众号后台配置截图路径

1. 登录后台 → 左侧菜单"开发"
2. "开发" → "基本配置"
3. 下滑找到"IP白名单"
4. 点击"查看"或"修改"
5. 输入IP地址，每行一个
6. 点击"确定"保存

## 验证配置是否成功

配置完成后，在设置页面点击"测试连接"按钮：
- ✅ 绿色打钩：配置成功
- ❌ 红色叉号：配置失败，请检查IP是否正确

## 技术支持

如果按照上述步骤操作后仍然失败，可能的原因：
1. IP地址输入错误（多余的空格、字符等）
2. 微信后台配置未保存成功
3. 网络延迟，等待几分钟后重试
4. AppID或AppSecret配置错误

---

**更新时间**: 2025-12-19
**版本**: v1.0.0



